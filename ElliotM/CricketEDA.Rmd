---
title: "Exploratory Data Analysis for ODI Cricket"
author: "Elliot Moore"
date: "2025-10-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, include=FALSE}
# Load libraries
library(tidyverse)
library(tidyr)
```

## Introduction
We are investigating the $\texttt{cricketdata}$ package here, so first we will 
load the required libraries and then we can start our analysis. The package 
$\texttt{cricketdata}$ includes data for Test, ODI and T20 cricket, for Men's and
Women's cricket, however for now we are going to focus on Men's ODI matches. In
particular, we are interested in what factors affect the match outcome in the 
*powerplay*. 

## Powerplay
There are two *powerplays* in each match, the batting powerplay which
is the first 10 overs and the bowling powerplay which is the final 10 overs. During
the batting powerplay, the fielding team is only allowed a maximum of two players
outside the 30-yard circle, encouraging the batting team to take more risk and 
go for boundaries (fours and sixes). The final powerplay favours the bowling team,
and a maximum of 5 fielders are allowed outside the 30-yard circle.


```{r, warning=FALSE,results='hide'}
# Here we load the required libraries
library(fs)
library(readr)
library(ggplot2)
library(knitr)
library(dplyr)
library(cricketdata)
```


```{r, warning=FALSE, results='hide',message=FALSE}
# Here we get our data
data <- read_csv(path_wd("..", "data", "processed", "odi_bbb_recent.csv"))

```


```{r}
glimpse(data)
```


Firstly, I wanted to check to see if winning the toss, that is the coin toss to
determine which team chooses to bat first or bowl first, has any impact on the 
match outcome.

Since we have ball by ball data, it's a good idea to summarise the data first, 
only keeping the key information.


## Toss Decision
```{r, Heatmap 1}
heatmap_data <- data %>%
  distinct(match_id, toss_winner, toss_decision, winner) %>%
  mutate(toss_winner_won = ifelse(toss_winner == winner, "Yes", "No")) %>%
  count(toss_decision, toss_winner_won) %>%
  group_by(toss_decision) %>%
  mutate(perc = n / sum(n) * 100)

ggplot(heatmap_data, aes(x = toss_decision, y = toss_winner_won, fill = perc)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.1f%%", perc)), color = "black", size = 5) +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(
    title = "Toss Decision vs. Match Outcome (as % of Toss Decisions)",
    x = "Decision After Winning Toss",
    y = "Did Toss Winner Also Win?",
    fill = "Percentage"
  ) +
  theme_minimal()

```



```{r, Toss Winning Heatmap}
heatmap_data <- data %>%
  distinct(match_id, toss_winner, toss_decision, winner) %>%
  # ðŸ”¹ Remove matches with no result
  filter(!is.na(winner)) %>%
  mutate(toss_winner_won = ifelse(toss_winner == winner, "Yes", "No")) %>%
  count(toss_decision, toss_winner_won) %>%
  group_by(toss_decision) %>%
  mutate(perc = n / sum(n) * 100)

ggplot(heatmap_data, aes(x = toss_decision, y = toss_winner_won, fill = perc)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.1f%%", perc)), color = "white", size = 5) +
  scale_fill_gradient(low = "red", high = "orange") +
  labs(
    title = "Toss Decision vs. Match Outcome",
    x = "Decision After Winning Toss",
    y = "Did Toss Winner Also Win?",
    fill = "Percentage"
  ) +
  theme_minimal()



```



Here, NA is no match outcome - some matches are rained off or cancelled for other
reasons. Therefore I decided to remove this from the heatmap as it is not
useful data. The heatmap shows us that deciding to field first is the better decision
when all other factors are ignored - weather and pitch quality are usually the 
main factors considered by teams.

## Powerplay Analysis

Let's take a look at the powerplay - in particular how many boundaries are scored
during the batting powerplay and how many wickets are lost. The big idea here 
being that if we were building a model for predicting match outcome as the game 
is being played, the powerplay would be a key indicator of how well a team's innings
is going.

```{r, Powerplay boundaries}
powerplay_boundaries <- data %>%
  filter(ball < 10, runs_off_bat %in% c(4, 6)) %>%  # only Powerplay & boundaries
  group_by(match_id, batting_team) %>%
  summarise(boundaries = n(), .groups = "drop")

powerplay_outcome <- data %>%
  distinct(match_id, batting_team, winner) %>%
  mutate(result = ifelse(batting_team == winner, "Won", "Lost"))

powerplay_summary <- powerplay_boundaries %>%
  left_join(powerplay_outcome, by = c("match_id", "batting_team")) %>%
  filter(!is.na(result))

```


```{r}
powerplay_summary %>%
  ggplot(aes(x = boundaries, fill = result)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 15) +
  scale_fill_manual(values = c("Won" = "green", "Lost" = "red")) +
  labs(title = "Boundaries in Powerplay vs Match Outcome",
       x = "Number of Boundaries in First 10 Overs",
       y = "Number of Innings",
       fill = "Match Result") +
  theme_minimal()

```
This distribution shows very clearly that teams that score more boundaries in the
batting powerplay tend to win more matches - the green distribution is left skewed.

Let's also look at wickets during the batting powerplay - if a team loses more 
wickets early on in the game, we'd expect them to lose the match on average.

```{r}
powerplay_stats <- data %>%
  filter(ball < 10) %>%
  group_by(match_id, batting_team) %>%
  summarise(
    boundaries = sum(runs_off_bat %in% c(4, 6)),       # count boundaries
    wickets = sum(!is.na(wicket_type)),                # count wickets lost
    .groups = "drop"
  )

match_outcomes <- data %>%
  distinct(match_id, batting_team, winner) %>%
  mutate(result = ifelse(batting_team == winner, "Won", "Lost"))

powerplay_summary <- powerplay_stats %>%
  left_join(match_outcomes, by = c("match_id", "batting_team")) %>%
  filter(!is.na(result))

```





```{r}
powerplay_summary %>%
  group_by(wickets) %>%
  summarise(win_rate = mean(result == "Won"), n = n(), .groups = "drop") %>%
  ggplot(aes(x = wickets, y = win_rate)) +
  geom_point(size = 3, color = "blue") +
  geom_line(group = 1, color = "blue") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Win Probability vs Wickets Lost in Powerplay",
       x = "Wickets Lost (First 10 Overs)",
       y = "Win Probability") +
  theme_minimal()



```
This plot shows the rapid and clear decline of win probability as the batting team
loses wickets in the powerplay.
