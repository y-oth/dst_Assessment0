---
title: "Untitled"
output: html_document
date: "2025-10-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(ggplot2)
library(fs)
library(knitr)
library(dplyr)
library(tidyr)
```

```{r load_data, message=FALSE}
data <- read_csv("data/processed/odi_bbb_recent.csv")
```

This analysis has been more focused on teaching myself the basics of cricket, like learning the rules and how the game works etc... A part of this included making basic visual plots of key performance indicators to tell me what a normal game would looks like in terms of statistics.

The dataset we have has over 620000 lines of data, where each line is one ball in the form of a decimal. We find that this decimal is represented as x.y, where x represents the over (starting at 0), and y represents the number ball (eg a ball of 2.4 is the fourth ball in the third over). For parts of this analysis, we will want to look at overs, so we can make an overs column by using the floor function and simply adding 1.

```{r}
data <- data %>%
  mutate(over=floor(ball)+1)
```

```{r preview}
glimpse(data)
```

# Initial plots

As someone who really doesn't know much about cricket, I want to start off with getting an idea of what the performance indicators are, and what could be expected in a game. 

I will do this by creating some general plots to look at the distributions of some of the columns from our data. This is to find roughly how often something occurs (eg a batters dismissal, average number of runs, boundaries etc...) for the purpose of getting a naive idea of what 'good' and 'bad' performances are.

First we will make a new dataset from our odi_bbb_recent where instead of having one row represent one ball, we make it so one row will represents one inning. This is to simplify our plots and get a wider view on some performance indicators. 
The metrics I will be plotting the distributions for are runs, wickets and boundaries.

```{r}
metrics <- data %>%
  group_by(match_id,innings) %>%
  summarise(total_runs= sum(runs_off_bat), total_wickets = sum(!is.na(player_dismissed)), boundaries = sum(runs_off_bat %in%c(4, 6)),.groups= "drop")

head(metrics)
```

```{r}
ggplot(metrics,aes(x = total_runs))+
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "steelblue", alpha = 0.7)+
  labs(title = "Distribution of total runs per inning", subtitle = sprintf("Mean = %.1f runs", mean(metrics$total_runs)), x = "Total Runs", y = "Density")
```
This is a fairly standard plot, following what appears to be a normal distribution

Now we look at the distribution of wickets (dismissal of a batter) per inning.

```{r}
ggplot(metrics,aes(x = total_wickets))+
  geom_histogram(aes(y = after_stat(density)), bins = 10, fill = "steelblue", alpha = 0.7)+
  labs(title = "Distribution of total wickets per inning", subtitle = sprintf("Mean = %.1f wickets", mean(metrics$total_wickets)), x = "Wickets", y = "Density")
```
This plot confused me at first, as from what I learned about the rules, the inning is over when the batting team loses 10 wickets, though the mean being 7.4 shows that a fair amount of the time that isn't the case. Only until after I realised that for ODI matches, there is a set limit of 50 overs per inning, though this could also be caused by a team reaching their target and beating the other team.

Something else that caught my eye was the slight spike at around the 2~3 mark, though after consulting with chatGPT, it suggested that it is likely from the second innings where the chasing team wins easily.



Finally we look at boundaries per inning, boundaries being defined as scoring 4 or 6 runs (4 if the ball rolls out of the boundary, 6 if the ball lands outside of the boundary without bouncing)

```{r}
ggplot(metrics,aes(x = boundaries))+
  geom_histogram(aes(y = after_stat(density)), bins = 20, fill = "steelblue", alpha = 0.7)+
  labs(title = "Distribution of total boundaries per inning", subtitle = sprintf("Mean = %.1f boundaries", mean(metrics$boundaries)), x = "Boundaries", y = "Density")
```
This is again relatively standard. It has a slight skew but appears similiar to the plot of the distribution of runs.



Here we will try and match these metrics we have just plotted with respective teams. This is to get a basic understanding of which teams generally perform than others. As these metrics are on different scales (runs have mean ~220 when wickets have an average of ~7) we must standardise these values so not all metrics are the same colour in their respective column. The way we will standardise is by subtracting the mean and dividing by the standard deviation. We must also reverse the colours for the wickets lost column, as in this case the less wickets lost the better.

Here I have chosen to do green is 'better' and red is 'worse', so if say a team scores more runs than the average, their cell will be a darker green. The idea here is to have a look at which teams are better and where - a team that has a green row is typically good, and a team that has a red row is pretty bad.

```{r}
team_performance <- data %>% #make data set
  group_by(match_id, innings, batting_team) %>%
  summarise(runs = sum(runs_off_bat),wickets = sum(!is.na(player_dismissed)),boundaries = sum(runs_off_bat %in% c(4, 6)),.groups = "drop") %>%
  group_by(batting_team) %>%
  summarise(avgruns = mean(runs),avgwickets = mean(wickets),avgboundaries = mean(boundaries),n_innings = n(),.groups = "drop")

team_heatmap_data <- team_performance %>%
  select(batting_team, avgruns, avgwickets, avgboundaries) %>%
  pivot_longer(cols = c(avgruns, avgwickets, avgboundaries),names_to = "metric",values_to = "value")
```

```{r}
team_heatmap_data <- team_heatmap_data %>%
  group_by(metric) %>%
  mutate(standardized_value = if_else(metric == "avgwickets", -(value - mean(value)) / sd(value),(value - mean(value)) / sd(value))) %>% #standardise metric by subtracting mean and dividing by standard deviation
  ungroup() #reverse for wickets as less wickets is better

ggplot(team_heatmap_data, aes(x = metric, y = batting_team, fill = standardized_value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.1f", value)), color = "black", size = 3) +
  scale_fill_gradient2(low = "red", mid = "white", high = "darkgreen", midpoint = 0) +
  labs(title = "Average Team Performance Across Key Metrics",subtitle = "Green = better performance, Red = worse performance (relative to average)",x = "Performance Metric",y = "Team",fill = "Standardized\nValue") +
  scale_x_discrete(labels = c("avgboundaries" = "Boundaries","avgruns" = "Runs","avgwickets" = "Wickets Lost"))
```
This plot is to have a look at which teams perform better than others. Can see the strongest teams are England, India and Australia, closely followed by South Africa. The worst team in terms of the metrics on the chart is Papua New Guinea, who have the worst performance in each metric.

## Scoring Streaks and Momentum

Now we've gotten some idea of what an average game looks like in terms of runs, wickets and boundaries, we will explore something more specific in game momentum. If a team scores well in one over, this is asking the question will that carry on into the next.

After looking online, I see generally 7-9 runs in an over is a good over. We can confirm this as if a batting team averages 8 runs in an over in 50 overs they will end up with 400 runs, being a very good score. As we are looking at momentum gained after a good over, we will classify a big over as an over with 10+ runs.

```{r}
over_runs <- data %>% #get runs per over
  group_by(match_id, innings, over) %>%
  summarise(runs_in_over = sum(runs_off_bat),.groups = "drop") %>%
  arrange(match_id, innings, over) %>%
  group_by(match_id, innings) %>%
  mutate(next_over_runs = lead(runs_in_over),prev_over_runs = lag(runs_in_over)) %>%
  ungroup()

scoring_comparison <- over_runs %>% #compare what happens after big overs vs normal overs
  filter(!is.na(next_over_runs)) %>%
  mutate(over_type = case_when(runs_in_over >= 10 ~ "Big Over (10+)",runs_in_over <= 3 ~ "Quiet Over (0-3)",TRUE ~ "Normal Over (4-7)"))
```

```{r}
scoring_comparison %>%
  ggplot(aes(x = over_type, y = next_over_runs, fill = over_type)) +
  geom_boxplot() +
  scale_fill_manual(values = c("Big Over (10+)" = "yellow","Normal Over (4-9)" = "white","Quiet Over (0-3)" = "blue")) +
  labs(title = "Runs in Next Over Based on Current Over Performance",x = "Current Over Type",y = "Runs in Next Over",fill = "Over Type")

```
We can see there is a difference for runs in an over depending on the past overs run count, which could signal that momentum has an effect, but could also be explained by a mismatched game (team being much better than opponent, meaning on average their runs per over would be higher).

## Winning Streaks Across Matches

A natural progression from single match momentum is to analyse momentum over multiple matches.

For analysis, we are going to prepare a data set arranged in teams, that will have a binary classification win = 1, lose = 0 and then make a score for the outcome of the previous 3 or so games. The charts we will make are win percentage given outcome of last match, and winning percentage given outcomes of last 3 matches.

```{r}
match_results <- data %>% #getting match results for each team in chronological order
  distinct(match_id, start_date, team1, team2, winner) %>%
  filter(!is.na(winner)) %>% #remove any non-conclusive matches
  arrange(start_date)

team_match_records <- bind_rows(match_results %>% 
    select(match_id, start_date, team = team1, winner),match_results %>% 
    select(match_id, start_date, team = team2, winner)) %>%
  arrange(team, start_date) %>% #so that each row represents each record
  mutate(won = ifelse(team == winner, 1, 0)) #binary win = 1, lose = 0

team_streaks <- team_match_records %>% #calculate score for previous matches
  group_by(team) %>%
  mutate(prev_result = lag(won),prev_2_results= lag(won) + lag(won, 2),prev_3_results= lag(won) + lag(won, 2) + lag(won, 3)) %>%
  filter(!is.na(prev_result)) %>%
  ungroup()

glimpse(team_streaks)
```
As an introduction to multi match momentum, we will first start with the probability a team wins a game, given the outcome of their previous game. We do this by setting the 

```{r}
team_streaks %>%
  mutate(previous_match = ifelse(prev_result == 1, "Won Last Match", "Lost Last Match")) %>%
  group_by(previous_match) %>%
  summarise(win_rate = mean(won),n = n(),.groups = "drop") %>%
  ggplot(aes(x = previous_match, y = win_rate, fill = previous_match)) +
  geom_col() +
  geom_text(aes(label = sprintf("%.1f%%", win_rate * 100)), size = 5) +
  scale_fill_manual(values = c("Won Last Match" = "green", "Lost Last Match" = "red")) +
  labs(x = "Previous Match Result",y = "Win Rate in Current Match")
```
This plot doesn't seem overly useful to us, as it doesn't really tell us anything. Looking at the binary 'win match/lose match', every game is included in this calculation as every game is either won or lost. One possible interpretation could be that it shows the difference in team quality, how much better the good teams are compared to the bad ones. Still, it is a simple easy to understand plot so I thought I may as well include it.

We can try and improve the plot by extending it to winning probability given a winning streak. This could be 

```{r}
team_streaks %>% #
  filter(!is.na(prev_3_results)) %>%
  mutate(streak = case_when(prev_3_results == 3 ~ "Won last 3",prev_3_results == 0 ~ "Lost last 3",TRUE ~ "Mixed recent form")) %>% #3 wins = 1+1+1=3, 3 losses = 0+0+0=0
  group_by(streak) %>%
  summarise(win_rate = mean(won),n = n(),.groups = "drop") %>%
  ggplot(aes(x = reorder(streak, win_rate), y = win_rate, fill = streak)) +
  geom_col() +
  geom_text(aes(label = sprintf("%.1f%%", win_rate * 100)), vjust = -0.5, size = 4) +
  coord_flip() +
  scale_fill_manual(values = c("Won last 3" = "green", "Mixed recent form" = "yellow","Lost last 3" = "red")) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 0.7)) +
  labs(title = "Win Rate Based on Recent Form (Last 3 Matches)",x = "Recent Form",y = "Win Rate in Current Match")
```
This can be viewed as winning streaks having an effect on winning probability, and hence supporting the idea that momentum is significant, though again it could also be interpreted as if a team is on a winning streak, they may just be a good team who wins more on average. This plot tells us more than the previous, though it definitely isn't conclusive.